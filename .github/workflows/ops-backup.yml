name: Ops Backup

on:
  schedule:
    # 02:30 KST daily (17:30 UTC)
    - cron: "30 17 * * *"
  workflow_dispatch:

concurrency:
  group: ops-backup
  cancel-in-progress: false

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Resolve backup variables
        id: resolve
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_PORT: ${{ secrets.PROD_PORT }}
          PROD_PUBLIC_URL: ${{ secrets.PROD_PUBLIC_URL }}
        run: |
          set -euo pipefail

          host="${PROD_HOST:-}"
          if [ -z "$host" ] && [ -n "${PROD_PUBLIC_URL:-}" ]; then
            stripped="${PROD_PUBLIC_URL#*://}"
            stripped="${stripped%%/*}"
            stripped="${stripped%%:*}"
            host="$stripped"
          fi

          port="${PROD_PORT:-22}"
          echo "host=$host" >> "$GITHUB_OUTPUT"
          echo "port=$port" >> "$GITHUB_OUTPUT"

      - name: Validate required secrets
        env:
          RESOLVED_HOST: ${{ steps.resolve.outputs.host }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_APP_DIR: ${{ secrets.PROD_APP_DIR }}
        run: |
          set -euo pipefail
          if [ -z "${RESOLVED_HOST}" ]; then
            echo "Missing deploy host. Set PROD_HOST or PROD_PUBLIC_URL secret."
            exit 1
          fi
          for key in PROD_USER PROD_SSH_KEY PROD_APP_DIR; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key"
              exit 1
            fi
          done

      - name: Run backup and prune over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ steps.resolve.outputs.host }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ steps.resolve.outputs.port }}
          script_stop: true
          script: |
            set -euo pipefail
            cd "${{ secrets.PROD_APP_DIR }}"
            bash scripts/backup_prod.sh --env-file infra/.env.prod --output-dir backups
            bash scripts/prune_backups.sh --backup-root backups --keep-last 21
