name: Deploy Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Validate required secrets
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_PORT: ${{ secrets.PROD_PORT }}
          PROD_APP_DIR: ${{ secrets.PROD_APP_DIR }}
          PROD_PUBLIC_URL: ${{ secrets.PROD_PUBLIC_URL }}
        run: |
          set -euo pipefail
          for key in PROD_HOST PROD_USER PROD_SSH_KEY PROD_APP_DIR PROD_PUBLIC_URL; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key"
              exit 1
            fi
          done
          if [ -z "${PROD_PORT}" ]; then
            echo "Missing required secret: PROD_PORT (use 22 if default SSH port)"
            exit 1
          fi

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT }}
          script_stop: true
          script: |
            set -euo pipefail
            cd "${{ secrets.PROD_APP_DIR }}"
            git fetch --all --prune
            git pull --ff-only origin main
            bash scripts/deploy_prod.sh --env-file infra/.env.prod
            PUBLIC_BASE_URL="${{ secrets.PROD_PUBLIC_URL }}" bash scripts/ops_healthcheck.sh
