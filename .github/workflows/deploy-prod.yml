name: Deploy Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30
    steps:
      - name: Resolve deploy variables
        id: resolve
        env:
          PROD_HOST_SECRET: ${{ secrets.PROD_HOST }}
          PROD_HOST_VAR: ${{ vars.PROD_HOST }}
          PROD_PORT_SECRET: ${{ secrets.PROD_PORT }}
          PROD_PORT_VAR: ${{ vars.PROD_PORT }}
          PROD_PUBLIC_URL_SECRET: ${{ secrets.PROD_PUBLIC_URL }}
          PROD_PUBLIC_URL_VAR: ${{ vars.PROD_PUBLIC_URL }}
        run: |
          set -euo pipefail

          default_public_url="https://spartaqa.com"
          public_url="${PROD_PUBLIC_URL_SECRET:-${PROD_PUBLIC_URL_VAR:-$default_public_url}}"
          host="${PROD_HOST_SECRET:-${PROD_HOST_VAR:-}}"
          if [ -z "$host" ]; then
            stripped="$public_url"
            if [[ "$stripped" == *"://"* ]]; then
              stripped="${stripped#*://}"
            fi
            stripped="${stripped%%/*}"
            stripped="${stripped%%:*}"
            host="$stripped"
          fi
          if [ -z "$host" ]; then
            host="spartaqa.com"
          fi

          port="${PROD_PORT_SECRET:-${PROD_PORT_VAR:-22}}"

          echo "host=$host" >> "$GITHUB_OUTPUT"
          echo "port=$port" >> "$GITHUB_OUTPUT"
          echo "public_url=$public_url" >> "$GITHUB_OUTPUT"

      - name: Validate required secrets
        env:
          PROD_USER: ${{ secrets.PROD_USER != '' && secrets.PROD_USER || vars.PROD_USER || secrets.SSH_USER != '' && secrets.SSH_USER || vars.SSH_USER || 'ubuntu' }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY != '' && secrets.PROD_SSH_KEY || vars.PROD_SSH_KEY || secrets.SSH_PRIVATE_KEY != '' && secrets.SSH_PRIVATE_KEY || vars.SSH_PRIVATE_KEY || secrets.EC2_SSH_KEY != '' && secrets.EC2_SSH_KEY || vars.EC2_SSH_KEY }}
          PROD_APP_DIR: ${{ secrets.PROD_APP_DIR != '' && secrets.PROD_APP_DIR || vars.PROD_APP_DIR || secrets.APP_DIR != '' && secrets.APP_DIR || vars.APP_DIR || '/home/ubuntu/qa-lab' }}
        run: |
          set -euo pipefail
          for key in PROD_SSH_KEY; do
            if [ -z "${!key}" ]; then
              echo "Missing required deploy config: $key (set in Secrets or Variables)."
              exit 1
            fi
          done

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ steps.resolve.outputs.host }}
          username: ${{ secrets.PROD_USER != '' && secrets.PROD_USER || vars.PROD_USER || secrets.SSH_USER != '' && secrets.SSH_USER || vars.SSH_USER || 'ubuntu' }}
          key: ${{ secrets.PROD_SSH_KEY != '' && secrets.PROD_SSH_KEY || vars.PROD_SSH_KEY || secrets.SSH_PRIVATE_KEY != '' && secrets.SSH_PRIVATE_KEY || vars.SSH_PRIVATE_KEY || secrets.EC2_SSH_KEY != '' && secrets.EC2_SSH_KEY || vars.EC2_SSH_KEY }}
          port: ${{ steps.resolve.outputs.port }}
          script_stop: true
          script: |
            set -euo pipefail
            cd "${{ secrets.PROD_APP_DIR != '' && secrets.PROD_APP_DIR || vars.PROD_APP_DIR || secrets.APP_DIR != '' && secrets.APP_DIR || vars.APP_DIR || '/home/ubuntu/qa-lab' }}"
            git fetch --all --prune
            git pull --ff-only origin main
            bash scripts/deploy_prod.sh --env-file infra/.env.prod
            PUBLIC_BASE_URL="${{ steps.resolve.outputs.public_url }}" bash scripts/ops_healthcheck.sh
