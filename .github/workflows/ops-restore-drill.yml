name: Ops Restore Drill

on:
  schedule:
    # 03:30 KST every Sunday (18:30 UTC every Saturday)
    - cron: "30 18 * * 6"
  workflow_dispatch:

concurrency:
  group: ops-restore-drill
  cancel-in-progress: false

jobs:
  restore-drill:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Validate required secrets
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_PORT: ${{ secrets.PROD_PORT }}
          PROD_APP_DIR: ${{ secrets.PROD_APP_DIR }}
        run: |
          set -euo pipefail
          for key in PROD_HOST PROD_USER PROD_SSH_KEY PROD_APP_DIR; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key"
              exit 1
            fi
          done
          if [ -z "${PROD_PORT}" ]; then
            echo "Missing required secret: PROD_PORT (use 22 if default SSH port)"
            exit 1
          fi

      - name: Run restore drill over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT }}
          script_stop: true
          script: |
            set -euo pipefail
            cd "${{ secrets.PROD_APP_DIR }}"
            bash scripts/backup_restore_drill.sh --env-file infra/.env.prod --output-dir backups
            bash scripts/prune_backups.sh --backup-root backups --keep-last 21

